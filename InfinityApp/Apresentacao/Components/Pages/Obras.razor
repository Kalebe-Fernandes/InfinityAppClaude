@page "/obras"

@inject IServicoObra ServicoObra
@inject ServicoSincronizacaoPull SincPull
@inject NavigationManager Navigation

<PageTitle>Selecionar Obra - InfinityApp</PageTitle>

<div class="obras-container">
    <!-- Header -->
    <div class="obras-header">
        <h2>
            <i class="bi bi-building"></i>
            Selecionar Obra
        </h2>
        <button class="btn btn-primary" @onclick="SincronizarDados" disabled="@_sincronizando">
            @if (_sincronizando)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            else
            {
                <i class="bi bi-arrow-repeat"></i>
            }
            Sincronizar
        </button>
    </div>

    <!-- Barra de busca -->
    <div class="obras-busca">
        <div class="input-group">
            <span class="input-group-text">
                <i class="bi bi-search"></i>
            </span>
            <input 
                type="text" 
                class="form-control" 
                placeholder="Buscar obra..." 
                @bind="_textoBusca"
                @bind:event="oninput"
                @onkeyup="FiltrarObras" />
        </div>
    </div>

    <!-- Progresso da sincronização -->
    @if (_sincronizando && _progresso != null)
    {
        <div class="sincronizacao-progresso">
            <div class="progresso-info">
                <span class="progresso-mensagem">@_progresso.Mensagem</span>
                <span class="progresso-porcentagem">@_progresso.Porcentagem%</span>
            </div>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: @(_progresso.Porcentagem)%">
                </div>
            </div>
        </div>
    }

    <!-- Lista de obras -->
    @if (_carregando)
    {
        <div class="obras-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3">Carregando obras...</p>
        </div>
    }
    else if (!_obrasFiltradas.Any())
    {
        <div class="obras-vazio">
            <i class="bi bi-inbox"></i>
            <p>Nenhuma obra encontrada.</p>
            <button class="btn btn-outline-primary" @onclick="SincronizarDados">
                <i class="bi bi-arrow-repeat"></i>
                Sincronizar Dados
            </button>
        </div>
    }
    else
    {
        <div class="obras-lista">
            @foreach (var obra in _obrasFiltradas)
            {
                <div class="obra-card @(obra.Ativa ? "ativa" : "inativa")" 
                     @onclick="() => SelecionarObra(obra)">
                    <div class="obra-card-header">
                        <h5>@obra.Nome</h5>
                        @if (obra.Ativa)
                        {
                            <span class="badge bg-success">Ativa</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inativa</span>
                        }
                    </div>
                    <div class="obra-card-body">
                        <p class="obra-codigo">
                            <strong>Código:</strong> @obra.Codigo
                        </p>
                        <p class="obra-numero">
                            <strong>Número:</strong> @obra.Numero
                        </p>
                        @if (!string.IsNullOrEmpty(obra.Descricao))
                        {
                            <p class="obra-descricao">@obra.Descricao</p>
                        }
                        <p class="obra-periodo">
                            <i class="bi bi-calendar"></i>
                            @obra.DataInicio.ToString("dd/MM/yyyy")
                            @if (obra.DataFim.HasValue)
                            {
                                <span> - @obra.DataFim.Value.ToString("dd/MM/yyyy")</span>
                            }
                        </p>
                    </div>
                    <div class="obra-card-footer">
                        <i class="bi bi-chevron-right"></i>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ObraDto> _obras = new();
    private List<ObraDto> _obrasFiltradas = new();
    private string _textoBusca = string.Empty;
    private bool _carregando = true;
    private bool _sincronizando = false;
    private ProgressoSincronizacao? _progresso;

    protected override async Task OnInitializedAsync()
    {
        await CarregarObras();
    }

    private async Task CarregarObras()
    {
        try
        {
            _carregando = true;
            StateHasChanged();

            _obras = (await ServicoObra.ObterTodasAsync()).ToList();
            _obrasFiltradas = _obras.Where(o => o.Ativa).OrderBy(o => o.Nome).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar obras: {ex.Message}");
        }
        finally
        {
            _carregando = false;
            StateHasChanged();
        }
    }

    private void FiltrarObras()
    {
        if (string.IsNullOrWhiteSpace(_textoBusca))
        {
            _obrasFiltradas = _obras.Where(o => o.Ativa).OrderBy(o => o.Nome).ToList();
        }
        else
        {
            var busca = _textoBusca.ToLower();
            _obrasFiltradas = _obras
                .Where(o => o.Ativa && (
                    o.Nome.ToLower().Contains(busca) ||
                    o.Codigo.ToLower().Contains(busca) ||
                    o.Numero.ToLower().Contains(busca)
                ))
                .OrderBy(o => o.Nome)
                .ToList();
        }

        StateHasChanged();
    }

    private async Task SincronizarDados()
    {
        try
        {
            _sincronizando = true;
            StateHasChanged();

            var progress = new Progress<ProgressoSincronizacao>(p =>
            {
                _progresso = p;
                InvokeAsync(StateHasChanged);
            });

            var resultado = await SincPull.SincronizarTudoAsync(progress);

            if (resultado.Sucesso)
            {
                await CarregarObras();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro na sincronização: {ex.Message}");
        }
        finally
        {
            _sincronizando = false;
            _progresso = null;
            StateHasChanged();
        }
    }

    private void SelecionarObra(ObraDto obra)
    {
        Navigation.NavigateTo($"/fichas?obraId={obra.Id}");
    }
}
