@page "/ficha/viagem-cb"

@inject IServicoObra ServicoObra
@inject IServicoServico ServicoServico
@inject IServicoEquipamento ServicoEquipamento
@inject IServicoDeposito ServicoDeposito
@inject ServicoFichaViagemCB ServicoFicha
@inject NavigationManager Navigation

<PageTitle>Viagem de CB - InfinityApp</PageTitle>

<div class="ficha-container">
    <div class="ficha-header">
        <button class="btn btn-outline-secondary" @onclick="Voltar">
            <i class="bi bi-arrow-left"></i>
            Voltar
        </button>
        <h2>
            <i class="bi bi-truck"></i>
            Viagem de CB
        </h2>
        <button class="btn btn-success" @onclick="Salvar" disabled="@_salvando">
            @if (_salvando)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            else
            {
                <i class="bi bi-check-lg"></i>
            }
            Salvar
        </button>
    </div>

    @if (_obraSelecionada != null)
    {
        <div class="ficha-form">
            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-building"></i>
                    <h4>Obra</h4>
                </div>
                <div class="info-display">
                    <strong>@_obraSelecionada.Nome</strong>
                    <span class="text-muted">@_obraSelecionada.Codigo</span>
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-clipboard-check"></i>
                    <h4>Serviço</h4>
                </div>
                <div class="form-group">
                    <label>Selecione o Serviço *</label>
                    <select class="form-select" @bind="_fichaDto.ServicoId">
                        <option value="">Selecione...</option>
                        @foreach (var servico in _servicos)
                        {
                            <option value="@servico.Id">@servico.Descricao (@servico.Unidade)</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-truck-front"></i>
                    <h4>Equipamento</h4>
                </div>
                <div class="form-group">
                    <label>Selecione o Equipamento *</label>
                    <select class="form-select" @bind="_equipamentoId">
                        <option value="">Selecione...</option>
                        @foreach (var equip in _equipamentos)
                        {
                            <option value="@equip.Id">@equip.Prefixo - @equip.Placa</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-calendar-clock"></i>
                    <h4>Data</h4>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" class="form-control" @bind="_fichaDto.DataProducao" />
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-arrow-left-right"></i>
                    <h4>Origem e Destino</h4>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Origem *</label>
                            <select class="form-select" @bind="_depositoOrigemId">
                                <option value="">Selecione...</option>
                                @foreach (var deposito in _depositos)
                                {
                                    <option value="@deposito.Id">@deposito.Nome</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Destino *</label>
                            <select class="form-select" @bind="_depositoDestinoId">
                                <option value="">Selecione...</option>
                                @foreach (var deposito in _depositos)
                                {
                                    <option value="@deposito.Id">@deposito.Nome</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-calculator"></i>
                    <h4>Quantidade</h4>
                </div>
                <div class="form-group">
                    <label>Número de Viagens *</label>
                    <input type="number" class="form-control" @bind="_quantidadeViagens" min="1" />
                </div>
            </div>

            <div class="form-section">
                <div class="section-header">
                    <i class="bi bi-chat-text"></i>
                    <h4>Observações</h4>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" rows="3" @bind="_fichaDto.Observacoes"
                              placeholder="Digite observações relevantes..."></textarea>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="ficha-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3">Carregando dados...</p>
        </div>
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? ObraId { get; set; }

    private ObraDto? _obraSelecionada;
    private List<ServicoDto> _servicos = new();
    private List<EquipamentoDto> _equipamentos = new();
    private List<DepositoDto> _depositos = new();
    private FichaViagemCBDto _fichaDto = new() { DataProducao = DateTime.Now };
    private Guid _equipamentoId;
    private Guid _depositoOrigemId;
    private Guid _depositoDestinoId;
    private int _quantidadeViagens = 1;
    private bool _salvando = false;

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        try
        {
            if (!ObraId.HasValue)
            {
                Navigation.NavigateTo("/obras");
                return;
            }

            _obraSelecionada = await ServicoObra.ObterPorIdAsync(ObraId.Value);

            if (_obraSelecionada != null)
            {
                _fichaDto.ObraId = _obraSelecionada.Id;
                _servicos = (await ServicoServico.ObterPorObraAsync(ObraId.Value)).ToList();
                _equipamentos = (await ServicoEquipamento.ObterPorTipoAsync("CaminhaoBasculante")).ToList();
                _depositos = (await ServicoDeposito.ObterTodosAsync()).ToList();
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar dados: {ex.Message}");
        }
    }

    private async Task Salvar()
    {
        try
        {
            _salvando = true;
            StateHasChanged();

            if (_fichaDto.ServicoId == Guid.Empty || _equipamentoId == Guid.Empty)
            {
                return;
            }

            await ServicoFicha.CriarAsync(_fichaDto);
            Navigation.NavigateTo($"/fichas?obraId={ObraId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao salvar: {ex.Message}");
        }
        finally
        {
            _salvando = false;
            StateHasChanged();
        }
    }

    private void Voltar()
    {
        Navigation.NavigateTo($"/fichas?obraId={ObraId}");
    }
}
