@inject IServicoAutenticacaoApp ServicoAuth
@inject NavigationManager Navigation

@if (_usuario != null)
{
    <div class="user-display">
        <div class="user-avatar">
            @GetIniciais(_usuario.Nome)
        </div>
        <div class="user-info">
            <span class="user-name">@_usuario.Nome</span>
            <span class="user-email">@_usuario.Email</span>
        </div>
        <button class="btn btn-sm btn-outline-secondary" @onclick="IrParaPerfil">
            <i class="bi bi-person-circle"></i>
        </button>
    </div>
}
else
{
    <div class="user-display-loading">
        <span class="spinner-border spinner-border-sm"></span>
    </div>
}

@code {
    private UsuarioDto? _usuario;

    protected override async Task OnInitializedAsync()
    {
        await CarregarUsuario();
    }

    private async Task CarregarUsuario()
    {
        try
        {
            var autenticado = await ServicoAuth.EstaAutenticadoAsync();
            if (autenticado)
            {
                _usuario = await ServicoAuth.ObterUsuarioAsync();
                StateHasChanged();
            }
        }
        catch
        {
            _usuario = null;
        }
    }

    private string GetIniciais(string nome)
    {
        if (string.IsNullOrEmpty(nome))
            return "?";

        var partes = nome.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (partes.Length == 1)
            return partes[0].Substring(0, Math.Min(2, partes[0].Length)).ToUpper();

        return $"{partes[0][0]}{partes[^1][0]}".ToUpper();
    }

    private void IrParaPerfil()
    {
        Navigation.NavigateTo("/perfil");
    }
}
